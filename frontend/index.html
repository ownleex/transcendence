<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Transcendence 42</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        section {
            position: relative;
            z-index: 10;
        }

        button {
            cursor: pointer;
        }
    </style>
    <script>
        (function migrateTokenKey() {
            try {
                const t = localStorage.getItem('token');
                if (t && !localStorage.getItem('jwt')) {
                    localStorage.setItem('jwt', t);
                    console.info('[auth] migrated localStorage.token -> localStorage.jwt');
                }
            } catch (e) { console.warn('token migration error', e); }
        })();
    </script>
    <script>
        (function () {
            try {
                const url = new URL(window.location.href);
                const t = url.searchParams.get('token');
                if (!t) return;
                if (window.location.pathname === '/reset-password') return;
                localStorage.setItem('jwt', t);
                url.searchParams.delete('token');
                window.history.replaceState({}, document.title, url.pathname + url.search + url.hash);

                (async () => {
                    try {
                        const r = await fetch('/api/user/me', { headers: { 'Authorization': 'Bearer ' + t } });
                        if (r.ok) {
                            const payload = await r.json();
                            if (payload?.success && payload.user) {
                                localStorage.setItem('me', JSON.stringify(payload.user));
                                window.dispatchEvent(new CustomEvent('auth:changed', { detail: { loggedIn: true } }));
                            }
                        }
                    } catch (e) { console.warn(e); }
                })();
            } catch (e) { console.warn(e); }
        })();
    </script>
    <script>
        // Tiny API helper used across the page
        const API_BASE = window.location.origin;
        async function apiRequest(endpoint, opts = {}) {
            const token = localStorage.getItem('jwt');
            const headers = opts.body instanceof FormData ? {} : { "Content-Type": "application/json" };
            if (token) headers['Authorization'] = `Bearer ${token}`;
            const res = await fetch(`${API_BASE}${endpoint}`, { ...opts, headers });
            const text = await res.text();
            let data;
            try { data = text ? JSON.parse(text) : {}; } catch { data = { raw: text }; }
            if (!res.ok) throw data;
            return data;
        }
    </script>
    <script>
        // OAuth intercept: clear client state before redirect and add prompt params
        document.querySelectorAll('a[data-oauth]').forEach(a => {
            a.addEventListener('click', (e) => {
                e.preventDefault();
                console.log('[auth debug] starting OAuth redirect to', a.href);
                // Clear client tokens so UI won't think user is still logged in
                localStorage.removeItem('token');
                localStorage.removeItem('jwt');
                sessionStorage.removeItem('token');
                sessionStorage.removeItem('jwt');
                debugState('cleared tokens before oauth redirect');
                // Build redirect URL
                const href = new URL(a.href, window.location.origin);
                // üü¢ GitHub
                if (/github/i.test(href.href)) {
                    href.searchParams.set('prompt', 'consent');
                    href.searchParams.set('allow_signup', 'false');
                }
                // üü¢ 42 Intra (our /api/auth/signin path or containing "intra.42.fr")
                else if (/auth\/signin/i.test(href.pathname) || /intra\.42\.fr/i.test(href.href)) {
                    href.searchParams.set('prompt', 'login');
                    href.searchParams.set('access_type', 'offline');
                }
                // fallback for others
                else {
                    href.searchParams.set('prompt', 'login');
                }
                // Navigate
                window.location.href = href.toString();
            });
        });
    </script>
    <script>
        // Use current origin so requests go to the same host the page was loaded from (LAN IP)
        const API_BASE = window.location.origin; // e.g. "https://192.168.1.74:3000"
    </script>

</head>
<body class="bg-gradient-to-br from-gray-100 to-white dark:from-gray-900 dark:to-gray-800 flex flex-col justify-center items-center min-h-screen transition-all duration-500 relative">
    <!-- HEADER SECTION -->
    <section id="header1-section" class="fixed top-0 left-0 w-full flex justify-between items-center p-4 bg-white dark:bg-gray-900 shadow-md z-50">
        <!-- Top Bar -->
        <div class="absolute top-5 left-6 text-xl font-semibold text-gray-800 dark:text-gray-100 select-none">
            Transcendence
        </div>

        <!-- Navbar -->
        <div class="absolute top-5 right-6 flex items-center space-x-3">
            <a href="#" id="link-signup" class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700 transition">Sign up</a>
            <a href="#" id="link-signin" class="px-4 py-2 rounded-lg bg-blue-500 text-white text-sm hover:bg-blue-600 transition">Sign in</a>
        </div>
    </section>
    <!-- SIGN IN SECTION -->
    <section id="signin-section" method="POST" action="https://localhost:3000/api/auth/signin" class="bg-white dark:bg-gray-900 shadow-xl rounded-2xl p-8 w-80 sm:w-96 text-center transition-all duration-500">
        <h2 class="text-2xl font-semibold mb-6 text-gray-800 dark:text-gray-100">Sign in</h2>

        <form id="signin-form">
            <input name="user" type="text" placeholder="Username or email"
                   class="w-full mb-3 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-400" required>
            <input name="password" type="password" placeholder="Password"
                   class="w-full mb-3 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-400" required>

            <div class="flex justify-between text-sm mb-4">
                <a href="#" id="goto-register" class="text-blue-500 hover:underline">Don't have an account?</a>
                <!-- updated: added id="forgot-link" -->
                <a href="#" id="forgot-link" class="text-blue-500 hover:underline">Forgot password?</a>
            </div>

            <button type="submit" id="signinBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg transition">Sign in</button>
            <p id="signin-message" class="mt-2 text-sm text-gray-600"></p>
            <div class="my-3 text-gray-500 dark:text-gray-400 text-sm">or</div>

            <a data-oauth href="https://saul-unsubpoenaed-lakeisha.ngrok-free.dev/api/auth/github/login"
               class="w-full flex items-center justify-center gap-2 border border-gray-300 dark:border-gray-700 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition">
                <img src="https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/github.svg" class="w-5" alt="GitHub logo">
                Sign in with GitHub
            </a>
            <a data-oauth href="https://saul-unsubpoenaed-lakeisha.ngrok-free.dev/api/auth/signin"
               class="w-full flex items-center justify-center gap-2 border border-gray-300 dark:border-gray-700 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 mt-2 transition">
                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='14' fill='%23007ACC'/><text x='50' y='62' font-size='42' text-anchor='middle' fill='white' font-family='system-ui,Arial,sans-serif'>42</text></svg>"
                     class="w-5 h-5" alt="42 logo">
                Sign in with 42 Intra
            </a>
        </form>

    </section>

    <!-- 2FA SECTION -->
    <section id="twofa-login-section" class="hidden bg-white dark:bg-gray-900 shadow-xl rounded-2xl p-8 w-80 sm:w-96 text-center">
        <h2 class="text-2xl font-semibold mb-4 text-gray-800 dark:text-gray-100">Enter 2FA Code</h2>

        <input id="twofa-login-token"
               maxlength="6"
               placeholder="6-digit code"
               class="w-full mb-4 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700">

        <button id="twofa-login-submit"
                class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg">
            Verify
        </button>

        <p id="twofa-login-msg" class="mt-3 text-sm text-gray-600"></p>
    </section>

    <!-- SIGN UP SECTION -->
    <section id="register-section" class="hidden bg-white dark:bg-gray-900 shadow-xl rounded-2xl p-8 w-80 sm:w-96 text-center transition-all duration-500">
        <h2 class="text-2xl font-semibold mb-6 text-gray-800 dark:text-gray-100">Sign up</h2>

        <form id="register-form" class="flex flex-col gap-3">
            <input id="username" type="text" placeholder="Username"
                   class="border p-2 rounded dark:bg-gray-800 dark:border-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-400" required />
            <input id="email" type="email" placeholder="Email"
                   class="border p-2 rounded dark:bg-gray-800 dark:border-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-400" required />
            <input id="password" type="password" placeholder="Password"
                   class="border p-2 rounded dark:bg-gray-800 dark:border-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-400" required />
            <button type="submit" class="bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">Sign up</button>
        </form>

        <p id="register-message" class="mt-2 text-center text-sm text-gray-600 dark:text-gray-400"></p>
        <p class="text-sm mt-3 text-gray-500 dark:text-gray-400">
            Already have an account?
            <a href="#" id="goto-signin" class="text-blue-500 hover:underline">Sign in</a>
        </p>

    </section>

    <!-- FORGOT PASSWORD SECTION -->
    <section id="forgot-section" class="hidden bg-white dark:bg-gray-900 shadow-xl rounded-2xl p-8 w-80 sm:w-96 text-center transition-all duration-500">
        <h2 class="text-2xl font-semibold mb-6 text-gray-800 dark:text-gray-100">Reset password</h2>

        <form id="forgot-form" class="flex flex-col gap-3">
            <label for="forgot-email" class="sr-only">Email address</label>
            <input id="forgot-email" type="email" placeholder="Enter your email"
                   class="border p-2 rounded dark:bg-gray-800 dark:border-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-400" required />

            <button type="submit" class="bg-blue-500 text-white py-2 rounded hover:bg-blue-600 transition">Send reset link</button>

            <p id="forgot-message" class="mt-3 text-sm text-gray-600 dark:text-gray-400"></p>

            <button id="back-to-signin" class="mt-4 text-sm text-gray-500 dark:text-gray-400 hover:underline">‚Üê Back to sign in</button>
        </form>
    </section>

    <section id="reset-section" class="hidden">
        <h2>Reset Password</h2>
        <form id="reset-form">
            <input type="password" id="new-password" placeholder="New password" required />
            <button type="submit">Reset Password</button>
            <p id="reset-message" class="mt-3 text-sm"></p>
        </form>
    </section>

    <!-- PONG DASHBOARD SECTION -->
    <section id="pong-section" class="hidden flex flex-col min-h-screen w-full bg-gray-100 dark:bg-gray-900 transition-all duration-500">
        <!-- Header -->
        <header class="w-full bg-gray-800 text-gray-100 shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <nav class="flex items-center justify-between h-16" aria-label="Pong navigation">

                    <!-- Brand -->
                    <div class="flex items-center space-x-3">
                        <span class="text-lg font-semibold select-none">Transcendence Pong</span>
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="hidden md:flex items-center gap-3">
                        <button id="homeBtn" class="px-3 py-1 rounded-md bg-blue-600 hover:bg-blue-700 focus:ring-2 focus:ring-blue-400">Home</button>
                        <button id="tournamentBtn" class="px-3 py-1 rounded-md bg-green-600 hover:bg-green-700 focus:ring-2 focus:ring-green-400">Tournament</button>
                        <button id="playersBtn" class="px-3 py-1 rounded-md bg-purple-600 hover:bg-purple-700 focus:ring-2 focus:ring-purple-400">Players</button>
                        <button id="matchesBtn" class="px-3 py-1 rounded-md bg-yellow-500 hover:bg-yellow-600 focus:ring-2 focus:ring-yellow-400">Matches</button>
                    </div>
                    <!-- ---------- User settings ---------- -->
                    <div class="flex items-center gap-2 ml-4 relative" id="user-menu-root">
                        <a id="user-profile-link" href="/profile" class="flex items-center gap-2 no-underline">
                            <img id="nav-avatar"
                                 class="h-8 w-8 rounded-full border border-gray-600"
                                 src="/uploads/default.png"
                                 alt="User avatar">
                            <span id="nav-username"
                                  class="sr-only md:not-sr-only text-sm font-medium text-gray-200"></span>
                        </a>
                        <!-- Arrow toggle button -->
                        <button id="userMenuBtn" aria-haspopup="true" aria-expanded="false"
                                class="ml-2 p-1 rounded hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-300"
                                title="Open user menu">
                            <!-- simple chevron (rotates when open) -->
                            <svg id="userMenuChevron" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform duration-150"
                                 viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06-.02L10 10.67l3.71-3.48a.75.75 0 111.02 1.1l-4.22 3.96a.75.75 0 01-1.02 0L5.25 8.29a.75.75 0 01-.02-1.08z" clip-rule="evenodd" />
                            </svg>
                        </button>

                        <!-- Dropdown menu -->
                        <div id="userMenuDropdown"
                             class="absolute right-0 top-full mt-2 w-40 bg-blue-600 dark:bg-blue-700 text-white border border-blue-700 rounded shadow-lg py-1 z-50 hidden"
                             role="menu" aria-labelledby="userMenuBtn">
                            <button type="button" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700"
                                    role="menuitem" data-target="profile-panel">
                                My profile
                            </button>
                            <button type="button" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700"
                                    role="menuitem" data-target="friends-panel">
                                Friends
                            </button>
                            <button type="button" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700"
                                    role="menuitem" data-target="matches-panel">
                                Matches
                            </button>
                            <button type="button" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700"
                                    role="menuitem" data-target="authentication-panel">
                                Authentication
                            </button>
                        </div>
                    </div>
                    <!-- Logout -->
                    <a href="#" id="logoutBtn" class="px-3 py-1 rounded-md bg-blue-600 hover:bg-blue-700 text-white text-sm focus:ring-2 focus:ring-blue-400">Sign out</a>
                </nav>
            </div>
        </header>
        <!-- PROFILE PANEL (update display name & avatar) -->
        <section id="profile-panel" class="hidden relative z-10 w-full max-w-4xl mt-8">
            <div class="bg-white dark:bg-gray-900 rounded-lg p-6">
                <div class="flex items-center gap-6">
                    <img id="profile-avatar" src="https://i.pravatar.cc/80" class="w-20 h-20 rounded-full border" />
                    <div>
                        <div id="profile-username" class="text-xl text-gray-600 font-semibold">‚Äî</div>
                        <div id="profile-email" class="text-sm text-gray-500">‚Äî</div>
                        <div class="mt-2 text-sm text-gray-600">ELO: <span id="profile-elo">‚Äî</span> ‚Ä¢ Matches: <span id="profile-matches">‚Äî</span> ‚Ä¢ Winrate: <span id="profile-winrate">‚Äî</span></div>
                    </div>
                </div>

                <hr class="my-4">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold mb-2 text-orange-500">Change display name</h4>
                        <form id="displayname-form" class="flex gap-2">
                            <input id="displayname-input" type="text" class="border p-2 rounded w-full" placeholder="Nickname / display name" />
                            <button type="submit" class="px-3 py-1 bg-blue-600 text-white rounded cursor-pointer">Update</button>
                        </form>
                        <p id="displayname-message" class="mt-2 text-sm text-gray-600"></p>
                    </div>

                    <div>
                        <h4 class="font-semibold mb-2 text-orange-500">Upload avatar</h4>
                        <form id="avatar-form" class="flex flex-col gap-2">
                            <input id="avatar-file" type="file" accept="image/*" />
                            <button type="submit" class="px-3 py-1 bg-blue-600 text-white rounded w-32 cursor-pointer">Upload</button>
                        </form>
                        <p id="avatar-message" class="mt-2 text-sm text-gray-600"></p>
                    </div>
                </div>

                <div class="mt-4">
                    <button onclick="showSection('pong-section')" class="px-3 py-1 bg-blue-600 rounded cursor-pointer">Back</button>
                </div>
            </div>
        </section>

        <!-- FRIENDS PANEL -->
        <section id="friends-panel" class="hidden w-full max-w-4xl mt-8">
            <div class="bg-white dark:bg-gray-900 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-3 text-orange-500">Friends</h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-medium text-orange-500">Your friends</h4>
                        <div id="friends-list" class="mt-3"></div>
                    </div>

                    <div>
                        <h4 class="font-medium text-orange-500">Add a friend</h4>
                        <form id="friend-send-form" class="flex gap-2 mt-3">
                            <input id="friend-username-input" class="border p-2 rounded w-full" placeholder="Friend username" />
                            <button type="submit" class="px-3 py-1 bg-blue-600 text-white rounded cursor-pointer">Send</button>
                        </form>
                        <p id="friend-send-message" class="mt-2 text-sm text-gray-600"></p>

                        <div class="mt-6">
                            <h5 class="font-medium text-orange-500">Incoming requests</h5>
                            <div id="friends-incoming" class="mt-2 text-sm text-gray-500"></div>
                        </div>
                        <div class="mt-6">
                            <h5 class="font-medium text-orange-500">Sent requests</h5>
                            <div id="friends-sent" class="mt-2 text-sm text-gray-500"></div>
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <button onclick="showSection('pong-section')" class="px-3 py-1 bg-blue-600 rounded cursor-pointer">Back</button>
                </div>
            </div>
        </section>

        <!-- MATCH HISTORY PANEL -->
        <section id="matches-panel" class="hidden w-full max-w-4xl mt-8">
            <div class="bg-white dark:bg-gray-900 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-3 text-orange-500">Match history</h3>
                <div id="matches-list"></div>

                <div class="mt-4">
                    <button onclick="showSection('pong-section')" class="px-3 py-1 bg-blue-600 rounded cursor-pointer">Back</button>
                </div>
            </div>
        </section>
        <!-- AUTHENTICATION PANEL -->
        <section id="authentication-panel" class="hidden w-full max-w-4xl mt-8">
            <div class="bg-white dark:bg-gray-900 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-3 text-orange-500">Two-Factor Authentication</h3>
                <button id="setup2FA" class="px-3 py-1 bg-blue-600 text-white rounded cursor-pointer">
                    Enable 2FA
                </button>
                <button id="disable2FA" class="px-3 py-1 bg-red-600 text-white rounded cursor-pointer hidden ml-2">
                    Disable 2FA
                </button>
                <div id="qrcode-container"></div>
                <div class="mt-4">
                    <button onclick="showSection('pong-section')" class="px-3 py-1 bg-blue-600 rounded cursor-pointer">Back</button>
                </div>
            </div>
        </section>
        <!-- Main -->
        <main id="pongContent" class="flex-1 p-8 space-y-10 text-center">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100">Welcome to Transcendence Pong!</h1>
            <p class="text-gray-600 dark:text-gray-300 max-w-2xl mx-auto">
                Play, compete, and rise through the ranks in the modern reimagining of the classic arcade game.
            </p>

            <!-- Quick Actions -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
                <div class="p-6 bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition">
                    <h2 class="text-xl font-semibold mb-2 text-gray-800 dark:text-gray-100">Start 2-Player Match</h2>
                    <button id="playDuoBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md">Play Duo</button>
                </div>

                <div class="p-6 bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition">
                    <h2 class="text-xl font-semibold mb-2 text-gray-800 dark:text-gray-100">Start 4-Player Match</h2>
                    <button id="playQuadBtn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md">Play Quad</button>
                </div>

                <div class="p-6 bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition">
                    <h2 class="text-xl font-semibold mb-2 text-gray-800 dark:text-gray-100">Join a Tournament</h2>
                    <p class="text-gray-500 dark:text-gray-400 mb-4">Compete in official events and climb the leaderboard.</p>
                    <button id="viewtournamentBtn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md">View Tournaments</button>
                </div>

                <div class="p-6 bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition">
                    <h2 class="text-xl font-semibold mb-2 text-gray-800 dark:text-gray-100">Leaderboard</h2>
                    <p class="text-gray-500 dark:text-gray-400 mb-4">See who‚Äôs dominating the Pong arena.</p>
                    <button class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-md">View Rankings</button>
                </div>
            </div>
            <div id="gameContainer" class="mt-8"></div>
        </main>

        <!-- Footer -->
        <footer class="text-center text-gray-400 py-4 border-t border-gray-700">
            Transcendence 42 &copy; 2025 ‚Äî Pong Module
        </footer>

    </section>

    <script>
        // header is persistent, hide/show other sections only
        function showSection(section) {
            const ids = ['signin-section', 'register-section', 'forgot-section', 'reset-section', 'pong-section'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            const target = document.getElementById(section);
            if (target) target.classList.remove('hidden');
            const header = document.getElementById('header1-section');
            if (header) header.classList.remove('hidden');
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('link-signin').addEventListener('click', (e) => {
                e.preventDefault();
                // header stays visible automatically
                showSection('signin-section');
            });

            document.getElementById('link-signup').addEventListener('click', (e) => {
                e.preventDefault();
                showSection('register-section');
            });

            document.getElementById('goto-register').addEventListener('click', (e) => {
                e.preventDefault();
                showSection('register-section');
                const header = document.getElementById('header1-section');
                if (header) header.classList.remove('hidden');
            });

            document.getElementById('goto-signin').addEventListener('click', (e) => {
                e.preventDefault();
                showSection('signin-section');
            });

            // Forgot password link -> show forgot section
            document.getElementById('forgot-link').addEventListener('click', (e) => {
                e.preventDefault();
                // prefill email from username/email field if possible
                const signinForm = document.getElementById('signin-form');
                const emailOrUser = signinForm ? signinForm.querySelector('input[name="user"]') : null;
                const forgotEmail = document.getElementById('forgot-email');
                if (emailOrUser && forgotEmail) {
                    forgotEmail.value = emailOrUser.value || '';
                }
                showSection('forgot-section');
                const header = document.getElementById('header1-section');
                if (header) header.classList.remove('hidden');
            });

            // Forgot form submit -> real API call

            document.getElementById('forgot-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('forgot-email').value.trim();
                const msg = document.getElementById('forgot-message');

                if (!email) {
                    msg.textContent = 'Please enter your email.';
                    msg.className = 'mt-3 text-sm text-red-600 dark:text-red-400';
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/api/auth/forgot`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email }),
                    });

                    const data = await response.json();

                    if (response.ok) {
                        msg.textContent = data.message || 'Email sent successfully!';
                        msg.className = 'mt-3 text-sm text-green-600 dark:text-green-400';
                    } else {
                        msg.textContent = data.error || 'Failed to send email.';
                        msg.className = 'mt-3 text-sm text-red-600 dark:text-red-400';
                    }
                } catch (err) {
                    console.error('Error sending email:', err);
                    msg.textContent = 'Network error ‚Äî please try again.';
                    msg.className = 'mt-3 text-sm text-red-600 dark:text-red-400';
                }
            });

            // Back to sign-in from forgot section
            document.getElementById('back-to-signin').addEventListener('click', (e) => {
                e.preventDefault();
                // clear message & email
                const msg = document.getElementById('forgot-message');
                const forgotEmail = document.getElementById('forgot-email');
                if (msg) { msg.textContent = ''; msg.className = 'mt-3 text-sm text-gray-600 dark:text-gray-400'; }
                if (forgotEmail) forgotEmail.value = '';
                showSection('signin-section');
            });
            // ‚úÖ Detect /reset-password?token=... and show reset form
            const params = new URLSearchParams(window.location.search);
            const token = params.get('token');
            if (token && window.location.pathname === '/reset-password') {
                showSection('reset-section');
                const header = document.getElementById('header1-section');
                if (header) header.classList.remove('hidden');
                document.getElementById('reset-form').dataset.token = token;
            }

            // Reset form submit
            document.getElementById('reset-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const token = form.dataset.token;
                const newPassword = document.getElementById('new-password').value.trim();
                const msg = document.getElementById('reset-message');

                if (!newPassword) {
                    msg.textContent = 'Please enter a new password.';
                    msg.className = 'mt-3 text-sm text-red-600';
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/api/auth/reset`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token, newPassword }),
                    });
                    const data = await response.json();
                    if (response.ok) {
                        msg.textContent = 'Password reset successful! You can now sign in.';
                        msg.className = 'mt-3 text-sm text-green-600';
                    } else {
                        msg.textContent = data.error || 'Failed to reset password.';
                        msg.className = 'mt-3 text-sm text-red-600';
                    }
                } catch (err) {
                    msg.textContent = 'Network error ‚Äî please try again.';
                    msg.className = 'mt-3 text-sm text-red-600';
                }
            });
        });
    </script>
    <script>
        (function bootstrapAuthAndUI() {
            if (window.location.pathname === '/reset-password') {
                console.log('[auth] reset-password page ‚Üí skipping auto-login');
                return;
            }
            // Helper UI toggles (no-ops if elements missing)
            const header1Section = document.getElementById('header1-section');
            const signinSection = document.getElementById('signin-section');
            const registerSection = document.getElementById('register-section');
            const pongSection = document.getElementById('pong-section');

            function showPongSection() {
                console.log('[auth] showPongSection()');
                if (header1Section) header1Section.classList.add('hidden');
                if (signinSection) signinSection.classList.add('hidden');
                if (registerSection) registerSection.classList.add('hidden');
                if (pongSection) pongSection.classList.remove('hidden');
            }
            function showSigninSection() {
                console.log('[auth] showSigninSection()');
                if (header1Section) header1Section.classList.remove('hidden');
                if (signinSection) signinSection.classList.remove('hidden');
                if (registerSection) registerSection.classList.add('hidden');
                if (pongSection) pongSection.classList.add('hidden');
            }

            // read token helpers
            function getJwtFromUrl() {
                try {
                    const p = new URLSearchParams(window.location.search);
                    return p.get('token');
                } catch (e) {
                    console.warn('[auth] getJwtFromUrl error', e);
                    return null;
                }
            }
            function getJwtFromStorage() {
                return localStorage.getItem('jwt') || sessionStorage.getItem('jwt') || localStorage.getItem('token') || sessionStorage.getItem('token') || null;
            }
            //Try URL query first (this should be early and quick)
            const urlToken = getJwtFromUrl();
            if (urlToken && window.location.pathname !== '/reset-password') {
                console.log('[auth] found token in URL:', urlToken.slice(0, 6) + '...');
                // store canonical location
                localStorage.setItem('jwt', urlToken);
                // clean the URL
                const cleanUrl = window.location.origin + window.location.pathname;
                try { window.history.replaceState({}, document.title, cleanUrl); } catch (e) {/* ignore */ }
                showPongSection();
                return;
            }
            //Try storage (landing page may have written it already)
            const existing = getJwtFromStorage();
            if (existing) {
                console.log('[auth] found token in storage:', existing.slice(0, 6) + '...');
                showPongSection();
                return;
            }
            //If opened as an OAuth popup landing that used window.opener.postMessage,
            // listen for a message for a short period.
            let messageHandled = false;
            function messageListener(ev) {
                try {
                    // adapt origin check as needed; accept any for debug, then lock down
                    const data = ev.data;
                    if (data && (data.token || data.jwt)) {
                        const t = data.token || data.jwt;
                        console.log('[auth] received token via postMessage:', ('' + t).slice(0, 6) + '...');
                        localStorage.setItem('jwt', t);
                        messageHandled = true;
                        window.removeEventListener('message', messageListener);
                        showPongSection();
                    }
                } catch (e) { console.warn('messageListener error', e); }
            }
            window.addEventListener('message', messageListener, false);
            // wait a tiny bit for possible message senders, then decide
            setTimeout(() => {
                if (messageHandled) return;
                // final fallback: no token found -> show sign-in
                console.log('[auth] no token found in url/storage/postMessage -> showing sign-in');
                showSigninSection();
                // remove listener to avoid leaks
                window.removeEventListener('message', messageListener);
            }, 600); // 600ms wait ‚Äî short but enough for popup postMessage
        })();
    </script>

    <script>
      	 document.addEventListener('DOMContentLoaded', () => {
         const signinForm = document.getElementById('signin-form');
         const twofaSubmitBtn = document.getElementById('twofa-login-submit');
         const twofaInput = document.getElementById('twofa-login-token');
 	 const twofaMsg = document.getElementById('twofa-login-msg');

 // Avoid crashing if the 2FA elements do not exist yet
 if (!twofaSubmitBtn || !twofaInput || !twofaMsg) {
     console.warn('2FA elements not found on page. Skipping 2FA setup.');
 }

            signinForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const user = e.target.user.value.trim();
                const password = e.target.password.value.trim();

                if (!user || !password) {
                    alert('Please enter both username and password.');
                    return;
                }

                try {
                    const res = await fetch(`${API_BASE}/api/auth/signin`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: user, password }),
                    });

                    const data = await res.json();
                    // 2FA REQUIRED ‚Üí show second-step UI
                    if (res.status === 403 && data.require2FA) { // backend sends require2FA
                        sessionStorage.setItem('pendingUser', user);
                        sessionStorage.setItem('pendingPass', password);
                        document.getElementById('signin-section')?.classList.add('hidden'); // hide signin
                        document.getElementById('twofa-login-section')?.classList.remove('hidden');
                        return;
                    }

                    // NORMAL LOGIN (no 2FA activated)
                    if (res.ok && data.token) {
                        // Save token and show Pong section
                        localStorage.setItem('token', data.token);
                        localStorage.setItem('jwt', data.token);
                        document.getElementById('header1-section').classList.add('hidden');
                        document.getElementById('signin-section').classList.add('hidden');
                        document.getElementById('register-section').classList.add('hidden');
                        document.getElementById('pong-section').classList.remove('hidden');
                        // ‚úÖ Update UI immediately
                        window.dispatchEvent(new CustomEvent('auth:changed', { detail: { loggedIn: true } }));
                        await window.loadCurrentUser();
                    } else {
                        alert(data.error || 'Invalid credentials');
                    }
                } catch (err) {
                    alert('Network error ‚Äî please try again.');
                }
            });
            // 2FA submit
            twofaSubmitBtn?.addEventListener('click', async () => {
                const code = twofaInput.value.trim();
                if (code.length !== 6) {
                    twofaMsg.textContent = 'Enter a valid 6-digit code';
                    twofaMsg.className = 'text-red-500';
                    return;
                }

                const username = sessionStorage.getItem('pendingUser');
                const password = sessionStorage.getItem('pendingPass');
                if (!username || !password) {
                    twofaMsg.textContent = 'Missing login info. Please sign in again.';
                    twofaMsg.className = 'text-red-500';
                    return;
                }

                try {
                    const res = await fetch(`${API_BASE}/api/auth/signin`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password, token: code })
                    });

                    const data = await res.json();
                    if (!data.success) {
                        twofaMsg.textContent = data.error || 'Invalid 2FA code';
                        twofaMsg.className = 'text-red-500';
                        return;
                    }

                    localStorage.setItem('token', data.token);
                    localStorage.setItem('jwt', data.token);

                    twofaMsg.textContent = 'Logged in!';
                    twofaMsg.className = 'text-green-500';

                    document.getElementById('header1-section')?.classList.add('hidden');

                    document.getElementById('twofa-login-section')?.classList.add('hidden');
                    document.getElementById('pong-section')?.classList.remove('hidden');

                    window.dispatchEvent(new CustomEvent('auth:changed', { detail: { loggedIn: true } }));

                    sessionStorage.removeItem('pendingUser');
                    sessionStorage.removeItem('pendingPass');

                } catch (err) {
                    twofaMsg.textContent = 'Network error. Try again.';
                    twofaMsg.className = 'text-red-500';
                }
            });
        });

        if (logoutBtn) {
            logoutBtn.addEventListener('click', async (e) => {
                e.preventDefault();

                try {
                    // Optionally call server to invalidate token (safe if you implement revoke endpoint)
                    const token = localStorage.getItem('token') || sessionStorage.getItem('token') || sessionStorage.getItem('jwt');
                    if (token) {
                        // best-effort: don't crash if server returns non-200
                        try {
                            await fetch(`${API_BASE}/api/auth/logout`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`,
                                },
                                body: JSON.stringify({}), // empty body OK
                            });
                        } catch (err) {
                            // ignore network error ‚Äî we'll still clear client state
                            console.warn('Server logout request failed (ignored):', err);
                        }
                    }

                    // Clear all known storage keys (backwards compat)
                    localStorage.removeItem('token');
                    localStorage.removeItem('jwt');
                    sessionStorage.removeItem('token');
                    sessionStorage.removeItem('jwt');

                    // Optionally clear other app state (unregister timers, sockets, etc.)
                    // e.g. if open a WebSocket, close it here: socket?.close();

                    window.location.href = '/frontend/index.html';

                } catch (err) {
                    console.error('Logout error:', err);
                    showSigninSection?.();
                }
            });
        }
    </script>

    <script>
        (function () {
            const menuBtn = document.getElementById('userMenuBtn');
            const dropdown = document.getElementById('userMenuDropdown');
            const chevron = document.getElementById('userMenuChevron');
            const root = document.getElementById('user-menu-root');

            //Stop clicks inside dropdown from triggering Pong clicks
            dropdown.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            // Panel IDs used in your markup
            const panelIds = ['profile-panel', 'friends-panel', 'matches-panel', 'authentication-panel'];
            // show a specific panel (hide others)
            function showPanel(panelId) {
                panelIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    if (id === panelId) {
                        el.classList.remove('hidden');
                        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } else {
                        el.classList.add('hidden');
                    }
                });
            }
            function toggleMenu(open) {
                const isOpen = dropdown.classList.contains('hidden') === false;
                const shouldOpen = (typeof open === 'boolean') ? open : !isOpen;

                if (shouldOpen) {
                    dropdown.classList.remove('hidden');
                    menuBtn.setAttribute('aria-expanded', 'true');
                    chevron.classList.add('rotate-180');
                } else {
                    dropdown.classList.add('hidden');
                    menuBtn.setAttribute('aria-expanded', 'false');
                    chevron.classList.remove('rotate-180');
                }
            }
            // Toggle on button click
            menuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleMenu();
            });
            // Close when clicking outside
            document.addEventListener('click', (e) => {
                if (!root.contains(e.target)) toggleMenu(false);
            });
            // Close on Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') toggleMenu(false);
            });
            // Wire menu item clicks to show panels
            dropdown.querySelectorAll('[role="menuitem"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const target = btn.getAttribute('data-target');
                    toggleMenu(false);
                    // slight delay to allow menu to close visually before panel in/out
                    setTimeout(() => showPanel(target), 100);
                });
            });
            // Wire "quick" buttons (if present) to open the corresponding panel
            const quickMapping = [
                { sel: 'profileBtnQuick', target: 'profile-panel' },
                { sel: 'friendsBtnQuick', target: 'friends-panel' },
                { sel: 'profileBtn', target: 'profile-panel' },
                { sel: 'friendsBtn', target: 'friends-panel' },
                // if you have other quick buttons, add them here
            ];
            quickMapping.forEach(m => {
                const el = document.getElementById(m.sel);
                if (el) {
                    el.addEventListener('click', (ev) => {
                        ev.preventDefault();
                        showPanel(m.target);
                        // scroll to panel
                        setTimeout(() => {
                            const p = document.getElementById(m.target);
                            if (p) p.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 50);
                    });
                }
            });
        })();
    </script>
    <script>
        (function () {
            const API_BASE = window.location.origin;

            // Elements
            const avatarPreview = document.getElementById('profile-avatar');
            const navAvatar = document.getElementById('nav-avatar');
            const usernameEl = document.getElementById('nav-username');
            const displayForm = document.getElementById('displayname-form');
            const displayInput = document.getElementById('displayname-input');
            const displayMsg = document.getElementById('displayname-message');
            const avatarForm = document.getElementById('avatar-form');
            const avatarFile = document.getElementById('avatar-file');
            const avatarMsg = document.getElementById('avatar-message');

            // ----------------------------
            // Utility to show one section
            // ----------------------------
            window.showSection = (id) => {
                document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
                const el = document.getElementById(id);
                if (el) el.classList.remove('hidden');
                if (id === "profile-panel") {
                    const me = JSON.parse(localStorage.getItem("me") || "{}");
                    if (me.id) {
                        // Use cached info first
                        const displayName = me.nickname?.trim() || me.username || "";
                        document.getElementById("profile-username").textContent = displayName;
                        document.getElementById("profile-email").textContent = me.email;
                        document.getElementById("profile-elo").textContent = me.elo ?? "0";
                        document.getElementById("profile-matches").textContent = me.matches_played ?? "0";
                        document.getElementById("profile-winrate").textContent = (me.winrate ?? 0) + "%";
                        if (me.avatar) document.getElementById("profile-avatar").src = me.avatar;
                    }
                    loadProfile();
                }
            }
            // ----------------------------
            // Apply user info to UI
            // ----------------------------
            function updateAvatar(url) {
                const avatarUrl = url + '?t=' + Date.now(); // cache bust
                if (avatarPreview) avatarPreview.src = avatarUrl;
                if (navAvatar) navAvatar.src = avatarUrl;
            }

            function applyUserToUI(user) {
                if (!user) return;

                const displayName = user.nickname?.trim() || user.username || '';
                if (usernameEl) {
                    usernameEl.textContent = displayName ? '@' + displayName : '';
                    usernameEl.classList.remove('sr-only', 'hidden');
                }

                let avatarPath = user.avatar || '/uploads/default.png';
                if (!/^https?:\/\//i.test(avatarPath)) avatarPath = new URL(avatarPath, API_BASE).href;
                updateAvatar(avatarPath);

                localStorage.setItem('me', JSON.stringify(user));
            }

            // ----------------------------
            // Load current user
            // ----------------------------
            async function loadCurrentUser() {
                try {
                    // Optimistic render from cache
                    const cached = localStorage.getItem('me');
                    if (cached) applyUserToUI(JSON.parse(cached));
                } catch (e) { /* ignore */ }

                try {
                    const token = localStorage.getItem('jwt');
                    const headers = { Accept: 'application/json' };
                    if (token) headers['Authorization'] = 'Bearer ' + token;

                    const resp = await fetch('/api/user/me', { method: 'GET', headers });
                    if (!resp.ok) {
                        localStorage.removeItem('me');
                        applyUserToUI({ avatar: '/uploads/default.png', username: '' });
                        return;
                    }

                    const { success, user } = await resp.json();
                    if (success && user) applyUserToUI(user);
                    else applyUserToUI({ avatar: '/uploads/default.png', username: '' });
                } catch (err) {
                    console.warn('Failed to load user:', err);
                }
            }

            window.loadCurrentUser = loadCurrentUser;
            loadCurrentUser();
            window.addEventListener('auth:changed', loadCurrentUser);

            // ----------------------------
            // Display name update
            // ----------------------------
            displayForm?.addEventListener('submit', async e => {
                e.preventDefault();
                displayMsg.textContent = 'Updating‚Ä¶';
                try {
                    const token = localStorage.getItem('jwt');
                    const newNickname = displayInput.value.trim();
                    const resp = await fetch('/api/user/displayname', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', ...(token ? { Authorization: 'Bearer ' + token } : {}) },
                        body: JSON.stringify({ nickname: newNickname })
                    });
                    const json = await resp.json();
                    if (!resp.ok || !json.success) throw new Error(json.error || 'Update failed');
                    displayMsg.textContent = 'Display name updated';
                    // Update localStorage immediately with new nickname
                    const me = JSON.parse(localStorage.getItem('me') || '{}');
                    me.nickname = newNickname;
                    localStorage.setItem('me', JSON.stringify(me));

                    // Update header username
                    const usernameEl = document.getElementById('nav-username');
                    if (usernameEl) usernameEl.textContent = '@' + newNickname;

                    // Update profile panel username
                    const profileUsernameEl = document.getElementById('profile-username');
                    if (profileUsernameEl) profileUsernameEl.textContent = newNickname;
                } catch (err) {
                    displayMsg.textContent = 'Error: ' + (err.message || err);
                }
            });

            // ----------------------------
            // Avatar upload
            // ----------------------------
            avatarForm?.addEventListener('submit', async e => {
                e.preventDefault();
                if (!avatarFile?.files?.length) {
                    avatarMsg.textContent = 'Please choose an image file';
                    return;
                }
                avatarMsg.textContent = 'Uploading‚Ä¶';
                try {
                    const fd = new FormData();
                    fd.append('file', avatarFile.files[0]);

                    const token = localStorage.getItem('jwt');
                    const resp = await fetch('/api/user/avatar', {
                        method: 'POST',
                        headers: token ? { Authorization: 'Bearer ' + token } : undefined,
                        body: fd
                    });
                    const json = await resp.json();
                    if (!resp.ok || !json.success) throw new Error(json.error || 'Upload failed');

                    avatarMsg.textContent = 'Uploaded';
                    if (json.avatar) {
                        updateAvatar(API_BASE + json.avatar);
                        const me = JSON.parse(localStorage.getItem('me') || '{}');
                        me.avatar = json.avatar;
                        localStorage.setItem('me', JSON.stringify(me));
                    } else {
                        await loadCurrentUser();
                    }
                } catch (err) {
                    avatarMsg.textContent = 'Error: ' + (err.message || err);
                }
            });

            // ----------------------------
            // Login helper
            // ----------------------------
            window.login = async function (username, password) {
                const resp = await fetch('/api/auth/signin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await resp.json();
                if (!resp.ok || !data.success) throw new Error(data.error || 'Login failed');

                localStorage.setItem('jwt', data.token);
                localStorage.setItem('me', JSON.stringify(data.user || {}));

                window.dispatchEvent(new CustomEvent('auth:changed', { detail: { loggedIn: true } }));
                await loadCurrentUser();
                return data;
            }
        })();
    </script>
    <script>

        async function loadProfile() {
            const me = JSON.parse(localStorage.getItem("me") || "{}");
            const token = localStorage.getItem("jwt");

            if (!me.id || !token) {
                console.warn("User not logged in");
                return;
            }
            const res = await fetch(`/api/user/${me.id}`, {
                headers: { "Authorization": `Bearer ${token}` }
            });
            const data = await res.json();
            if (!data.success) {
                console.error("Profile load failed:", data.error);
                return;
            }
            const user = data.user;
            const displayName = user.nickname?.trim() || user.username || "";
            document.getElementById("profile-username").textContent = displayName;
            document.getElementById("profile-email").textContent = user.email;
            document.getElementById("profile-elo").textContent = user.elo ?? "0";
            document.getElementById("profile-matches").textContent = user.matches_played ?? "0";
            document.getElementById("profile-winrate").textContent = (user.winrate ?? 0) + "%";
            if (user.avatar) {
                document.getElementById("profile-avatar").src = user.avatar;
            }
            localStorage.setItem("me", JSON.stringify(user));
        }
        // üî• Run when the user successfully logs in
        window.addEventListener("auth:changed", (e) => {
            if (e.detail.loggedIn) {
                loadProfile();
            }
        });
        // Optional: If already logged in on refresh
        document.addEventListener("DOMContentLoaded", () => {
            const token = localStorage.getItem("jwt");
            const me = JSON.parse(localStorage.getItem("me") || "{}");
            if (token && me.id) {
                loadProfile();
            }
        });
    </script>
    <script>
        document.getElementById("twofa-login-submit")?.addEventListener("click", async () => {
            const code = (document.getElementById("twofa-login-token") as HTMLInputElement).value.trim();
            const msg = document.getElementById("twofa-login-msg");

            if (code.length !== 6) {
                msg.textContent = "Enter a valid 6-digit code";
                msg.className = "text-red-500";
                return;
            }

            try {
                // Use the new backend route which reads JWT from Authorization header
                const jwt = localStorage.getItem('jwt') || sessionStorage.getItem('token');
                if (!jwt) {
                    msg.textContent = "No authentication token found. Please login again.";
                    msg.className = "text-red-500";
                    return;
                }

                const res = await fetch(`${API_BASE}/user/2fa/verify`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${jwt}`   // send JWT so server knows the user
                    },
                    body: JSON.stringify({ token: code })  // server expects { token }
                });

                const data = await res.json();

                if (!res.ok || !data.success) {
                    msg.textContent = data.error || "Invalid 2FA code";
                    msg.className = "text-red-500";
                    return;
                }

                // On success, server may optionally return a new JWT (refresh token flow)
                if (data.token) {
                    localStorage.setItem('jwt', data.token);
                    sessionStorage.setItem('token', data.token);
                }

                if (data.user) {
                    localStorage.setItem('me', JSON.stringify(data.user));
                    sessionStorage.setItem('me', JSON.stringify(data.user));
                }

                msg.textContent = "2FA verified successfully!";
                msg.className = "text-green-500";

                // Show main UI
                document.getElementById("twofa-login-section")?.classList.add("hidden");
                document.getElementById("pong-section")?.classList.remove("hidden");

                window.dispatchEvent(new CustomEvent('auth:changed', { detail: { loggedIn: true } }));

            } catch (err) {
                console.error("2FA login error:", err);
                msg.textContent = "Network error. Try again.";
                msg.className = "text-red-500";
            }
        });
    </script>


    <script type="module" src="./src/alias.ts"></script>
    <script type="module" src="./src/main.ts"></script>
</body>
</html>
